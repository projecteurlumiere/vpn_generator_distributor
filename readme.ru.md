# VPN Generator Distributor

> There is a [readme](./readme.md) available in English.

**VPN Generator Distributor** - это Телеграм бот для команд, которые уже работают с проектом [VPN Generator](https://vpngen.org/ru/) и желают оптимизировать и автоматизировать выдачу бесплатных ключей широким массам. Бот идеально подойдёт, если у вас уже есть несколько VPN серверов (ключниц) и площадка, с пользователями или подписчиками которой вы бы хотели поделиться ключами в анонимном порядке, а также оказать им всю дальнейшую поддержку при необходимости.

## Содержание

- [Преимущества](#преимущества)
- [Если вы разработчик](#если-вы-разработчик)
- [Первый запуск](#первый-запуск)
- [Подключение ключницы](#подключение-ключницы)
- [Редактирование ключницы](#редактирование-ключницы)
- [Редактирование инструкций и слайдов](#редактирование-инструкций-и-слайдов)
- [Общение с поддержкой и админский чат](#общение-с-поддержкой-и-админский-чат)
- [Выдача ключей через интерфейс администратора](#выдача-ключей-через-интерфейс-администратора)
- [Очистка ключниц от неактивных ключей](#очистка-ключниц-от-неактивных-ключей)
- [Массовые рассылки сообщений](#массовые-рассылки-сообщений)
- [Словарь](#словарь)

## Преимущества

### Для пользователей:

Бот максимально упрощает процесс для пользователя: 
- Пользователь заходит в бот, 
- Выбирает необходимое ему устройство, 
- Проходит пошаговую инструкцию по установке требуемой программы и получает ключ-конфигурацию для неё,
- Если возникли трудности, пользователь может связаться с администрацией через интерфейс бота.

### Для активистов и организаторов

Бот упрощает управление ключницами и выдачу ключей:
- Выдача с нескольких серверов-ключниц,
- Ведение общей базы данных для всех серверов
	- Бот не хранит пользовательские ключи в базе данных, но считает число выданных ключей, чтобы поддерживать лимит не более трёх ключей для одного Телеграм аккаунта.
- Мониторинг и очистка неактивных ключей в ключницах,
- Анонимная связь с пользователями, которым требуется помощь,
- Массовая рассылка пользователям, уже получившим ключ,
- Возможность отредактировать некоторые сообщения бота для соответствия духу вашего проекта или организации.

## Если вы разработчик

Это гайд для (потенциальных) администраторов, не знакомых с технической частью.

Если вы разработчик, вам может также пригодиться более лаконичное [readme на английском](./readme.md). Скорее всего, от вас требуется только запустить бот с помощью докера на выделенном сервере.

Если необходимо ручное вмешательство, войти в консоль бота можно с помощью `bin/console`. Ознакомьтесь со схемой (`./db/init.rb`) и моделями (`./models`), чтобы вручную работать ключницами, ключами, пользователями, и обращениями в поддержку. Обычно это не требуется, поскольку администраторы имеют все необходимые инструменты в интерфейсе бота.

## Первый запуск

Для установки бота необходимо:
- Подготовить токен в [BotFather](https://telegram.me/BotFather), чтобы подключить бота к бот-аккаунту в Телеграм
- Узнать `Telegram ID` потенциальных администраторов
	- Это можно сделать с помощью сторонних ботов либо обратиться к этому боту с командой `/tg_id`
- Подготовить супергруппу (группу-форум) в Телеграме для обработки обращений пользователей и узнать её `Telegram ID`
	- Это можно сделать с помощью сторонних ботов либо добавить бота в группу без конфигурации админского чата. В этом случае, бот сообщит, что администраторский чат не настроен, и отправит айди группы, в которую он попал.

Бот упакован в публично доступный (Докер образ)[https://hub.docker.com/r/projecteurlumiere/vpn_generator_distributor], который позволяет запустить его с помощью `Docker Compose`.

Подготовив сервер, создайте в желаемой директории конфигурационный файл `docker_compose.yml` и заполните его в соответствии с примером `docker_compose.yml.example`, [доступном в этом репозитории](./docker_compose.yml.example). Далее загрузите образ и запустите контейнер, как бы это сделали с любим другим Docker Compose проектом.

Для запуска бота используйте следующую команду в директории, где находится файл конфигурации бота:
```sh
docker compose up -d 
```

Для отключения бота:
```sh
docker compose down
```

Для обновления бота:
```sh
TBD
```

Для изменения настроек (токена, супергруппы, списка администраторов), отредактируйте `docker_compose.yml` и перезапустите бота.

Слайды, инструкции и файл базы данных хранятся на самом сервере - после первого запуска обязательно удостоверьтесь, что данные сохраняются между перезапусками и обновлениями контейнера.

Полагайтесь на бэкапы площадки, предоставляющей вам хостинг.

В случае переезда на другой сервер не забудьте скопировать на свой компьютер файл базы данных и `yaml` файлы инструкций и слайдов. Их можно мигрировать на новый сервер.

## Подключение ключницы

Чтобы бот мог подключиться к ключнице и начать выдавать из неё ключи, необходимо сообщить ему бригадирский ключ. Этот ключ будет постоянно храниться в базе данных бота.

>**В случае компроментации данных обязательно свяжитеcь с командой VPN Generator для перевыпуска бригадирского ключа.**

Подключить ключницу может только администратор бота (его `Telegram ID` должен быть указан в соответствующем разделе `docker_compose.yml`).

В меню `/admin` выберите раздел `Управление ключницами` и следуйте шагам по добавлению ключницы.

Для добавления ключницы вам будет необходимо указать:
- **Имя** - это ваше персональное название для неё, чтобы не спутать с другими ключницами. Оно не обязано совпадать с названием ключницы, которую вы видите в бригадирском интерфейсе.
	- Не может превышать 13 символов.
- **Максимальное число пользователей** - порог пользователей в ключнице, по достижении которого бот перестанет выдавать из неё ключи.
	- Не может превышать 250 (лимит ключниц).
	- Чтобы бот не выдавал ключи вообще. укажите значение 0. Это полезно, если вы хотите воспользоваться другими функциями бота, а потом отключить ключницу от него.
- **Ключ подключения** - бригадирский ключ для связи бота с сервером.

## Редактирование ключницы

В том же меню `Управление ключницами` можно отредактировать имя и число пользователей уже существующей ключницы. Также ключницу можно удалить из бота.

> **Если бот выдал хотя бы один ключ из ключницы, её нельзя удалить, пока не удалены выданные ключи**

## Редактирование инструкций и слайдов

Некоторые сообщения от бота, инструкции и слайды, можно индивидуально отредактировать, чтобы соответствовать идентичности вашего проекта или изменяющимся стратегиям обхода блокировок.

**Слайды** - это одиночные сообщения: разделы "О проекте" и "Правила", сообщение для массовой рассылки, сообщение при обращении в поддержку и так далее.

Они имеют вид `yaml` файлов, в котором указан текст сообщения, кнопки, которые появятся вместе с ним и внутренняя Телеграм ссылка для сопроводительного изображения.

Примеры слайдов и инструкций можно найти в папке `seeds`, доступной в репозитории. Они же будут использованы при первом запуске бота.

Слайд содержит:
* **Текст** (text) сообщения принимается в формате ``markdown`` - это позволяет форматировать текст по вашему желанию (курсив, цитаты, жирный шрифт).
	* При возникновении ошибок, проверьте правильность `markdown`разметки. Например `_` обозначает начало курсива, и Телеграм ожидает ещё один такой же символ для обозначения конца курсива. Если же вам нужно просто нижнее подчёркивание, его необходимо прописать через обратный слэш: `\_`.
* Текст **кнопок** (actions) изменять не надо, поскольку именно по тексту бот определяет, какое сообщение показать дальше.
* Чтобы добавить **изображения** (images) к тексту, отправьте изображению боту во время предпросмотра получившегося слайда. Ссылка будет автоматически добавлена в `yaml` файл - не изменяйте её, только если не хотите удалить полностью. Удалить изображения также можно через интерфейс бота при предпросмотре слайда с изображениям.

>**Ссылки на изображения привязаны к токену бота, который вы получили от [BotFather](https://telegram.me/BotFather. При смене токена все изображения придётся загрузить заново. Если возникают ошибки, отредактируйте `yaml` файлы, вручную удалив раздел `images`**

Редактирование **инструкции** происходит по такому же принципу. Отличие состоит в том, что в `yaml` файле инструкции находится несколько шагов-особщений и вы можете свободно менять текст кнопок: бот будет переходить к следующему шагу вне зависимости от текста кнопки. Также инструкции можно удалять или сохранять как черновики. Изображения добавляются для каждого отдельного шага инструкции при предпросмотре её шагов.

И инструкции, и слайды, хранятся на сервере постоянно, а также доступны для скачивания через администраторский интерфейс бота.

## Общение с поддержкой и админский чат

Пользователь может отправить обращение в поддержку в любой момент времени.

Поддержка организована с помощью супергруппы:
- Когда пользователь оставляет сообщение в поддержку, бот создаёт тему в супергруппе.
- Бот передаёт в эту тему текст обращения пользователя и создаёт сообщение-меню, с помощью которого члены супергруппы могут проверить текущие ключи пользователя, удалить ненужные или выдать новые.
- Любое сообщение оставленное пользователем супергруппы в теме-обращении будет переслано через бота соответствующему пользователю.
- Пользователь не сможет отправить дополнительные сообщения, пока обращение не станет _открытым_ (то есть на него ответят, взяв в работу). С этого момента сообщения пользователя боту будут так же пересылаться в чат-тему.
- Участники супергруппы не имеют доступа к персональными данными пользователей: все новые ключи высылаются напрямую пользователям, а сообщаемые `ID` имеют отношение только к внутренней базе данных бота.
- Когда вопрос решён, обязательно закройте тему с помощью интерфейса Телеграма - бот позаботится обо всём остальном.
	- Переоткрыть закрытую тему нельзя.
	- Написать пользователю в одностороннем порядке (то есть без его обращения) не представляется возможным.
- Если тема не переходит в статус открытой слишком долго, пользователь сможет послать новое обращение через несколько дней.

> **Любой участник супергруппы - это мини-администратор, который может взаимодействовать с любой темой-обращением и выдавать/забирать ключи в них. Не добавляйте в администраторскую супергруппу людей, которые не должны иметь доступ к вопросам, связанными с пользователями бота. Участие в супергруппе не даёт доступ к меню `/admin`**

Телеграм налагает ограничение на число сообщений бота в группе - не более 20 сообщений в _минуту_. По этой причине бот отправляет сообщения в группу очень не торопливо (с задержками от нескольких секунд). Не торопитесь, особенно если ведёте несколько диалогов поддержки одновременно.

## Выдача ключей через интерфейс администратора

В разделе `Управление пользователями`, который доступен в `/admin`, можно удалить или выдать ключи минуя интерфейс поддержки. Для этого необходимо указать внутренний (для бота) `ID` пользователя. Его можно узнать, отправив боту `/my_id`. 
 
## Очистка ключниц от неактивных ключей

Бот имеет возможность запрашивать статус пользователей в ключницах вне зависимости от того, был ли выдан ключ через бота или вручную. Настройка `"Мёртвые души"` в разделе `Управление ключницами` позволяет удалить неактивные (серые) и неактивированные (чёрные) ключи, освобождая места для новых пользователей. Эта процедура активируется вручную.

На первом шаге бот собирает данные из ключниц. Вы сможете оценить число ключей, которое будет удалено, и даже ознакомиться с конкретными никнеймами - вы можете их перепроверить в бригадирском интерфейсе. Если число кандидатов на удаление подозрительно высоко, возможно, стоит повременнить с автоматической очисткой.

На втором шаге бот приступает к удалению ключей. Этот процесс может затянуться, но вы обязательно получите отчёт о результате.

Если произошла ошибка, пройдите всю процедуру заново: запросите бота пересчитать число "мёртвых душ", сверьтесь с полученными данными и произведите новую очистку

## Массовые рассылки сообщений

Вы можете отправить массовое сообщение всем пользователям бота, которые имеют ключи. Сообщение можно отредактировать в меню слайдов, как было описано выше, и вы обязательно получите возможность предпросмотра сообщения перед рассылкой.

Используйте его для сообщений о падении серверов, изменении правил или других новостей, касающихся пользователей VPN'а.

По окончании рассылки вы получите отчёт о результате.

## Словарь

### VPN Generator
 **Ключница** - сервер VPN Generator'а, к которому у вас есть бригадирский (администраторский) доступ; вы можете подключить ключницу к боту, сообщив боту свой бригадирский ключ.
 
 **Ключ** -  конфигурация VPN, необходимая для подключения. Именно их, пользовательские ключи, генерируемые в ключнице, вы и желаете раздать пользователям.

### Бот 
**Пользовательский интерфейс** - функции бота, доступные всем пользователям Телеграма

**Интерфейс администратора** (админка) - функции бота, доступные только заранее указанным пользователям через команду `/admin`

**Администраторский (админский) чат** - групповой чат (обязательно супергруппа) в Телеграме, в котором обрабатываются анонимные обращения пользователей организаторам бота.

**Инструкция** - порядок шагов и действий внутри бота по установка ключа на то или иное устройство. На одном из шагов инструкции пользователь обязательно получает ключ для выбранной им платформы (и, как следствие, программы). Администратор бота имеет возможность добавить, удалить или отредактировать инструкции в администраторском интерфейсе. Каждая инструкция имеет формат `yaml`

**Слайд** - одиночной сообщение от бота, который администрация бота также имеет возможность отредактировать. Например, раздел 'О проекте' или 'Правила'.
